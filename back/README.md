## 1. Краткое описание

Данный микросервис представляет собой бэкенд-систему, разработанную для Telegram-бота, и предназначен для управления общими списками покупок. Сервис позволяет пользователям создавать персонализированные списки, добавлять в них товары, отмечать купленные позиции, делиться списками с другими пользователями для совместного ведения, а также завершать и удалять списки. Взаимодействие с сервисом осуществляется через REST API.

## 2. Архитектура и технологии

Сервис построен на асинхронном стеке технологий Python для обеспечения высокой производительности и масштабируемости.

*   **Язык программирования:** Python 3.9+
*   **Фреймворк:** FastAPI
*   **База данных:** MongoDB (с использованием асинхронного драйвера Motor)
*   **Веб-сервер:** Uvicorn
*   **Валидация данных:** Pydantic
*   **Управление зависимостями (рекомендуемое):** Poetry

**Обоснование выбора стека:**

*   **Python:** Выбран за простоту разработки, большое количество доступных библиотек и активное сообщество.
*   **FastAPI:** Современный, высокопроизводительный веб-фреймворк для создания API. Обеспечивает автоматическую валидацию данных (через Pydantic), генерацию интерактивной API-документации (Swagger UI, ReDoc) и построен на ASGI-стандарте (Starlette), что позволяет использовать асинхронность для повышения производительности.
*   **MongoDB (Motor):** NoSQL документо-ориентированная база данных, гибкость схемы которой хорошо подходит для хранения списков покупок и связанных с ними пользовательских данных. Асинхронный драйвер Motor интегрируется с асинхронной природой FastAPI.
*   **Uvicorn:** ASGI-сервер, необходимый для запуска FastAPI-приложений.
*   **Pydantic:** Используется FastAPI для определения, валидации и сериализации данных запросов и ответов, обеспечивая строгую типизацию и уменьшая количество ошибок.


## 3. Ключевые функции сервиса (API Endpoints)

Сервис предоставляет следующие основные возможности через API:

*   **Управление пользователями:**
    *   `GET /users/{user_id}/`: Получение информации о пользователе.
    *   `POST /users/actions/`: Обновление информации о действии пользователя.
    *   `GET /users/{user_id}/last_subscribed_list/`: Получение ID последнего списка, на который подписан пользователь.
    *   `POST /users/{user_id}/clear_last_subscribed_list/`: Очистка ID последнего списка, на который подписан пользователь.
*   **Управление списками покупок:**
    *   `POST /lists/?user_id={user_id}`: Создание нового списка покупок для пользователя.
    *   `GET /users/{user_id}/lists/`: Получение всех списков, к которым имеет доступ пользователь.
    *   `GET /lists/{list_id}/`: Получение информации о конкретном списке.
    *   `POST /lists/{list_id}/complete/`: Завершение (удаление) списка покупок.
    *   `POST /lists/{list_id}/share/`: Предоставление доступа к списку другому пользователю.
    *   `POST /lists/{list_id}/unsubscribe/`: Отписка пользователя от списка.
*   **Управление товарами в списке:**
    *   `GET /lists/{list_id}/items/`: Получение всех товаров в списке.
    *   `POST /lists/{list_id}/items/`: Добавление одного товара в список.
    *   `POST /lists/{list_id}/items/bulk/`: Массовое добавление товаров в список.
    *   `PUT /lists/{list_id}/items/{item_id}/toggle/`: Изменение статуса товара (куплен/не куплен).
    *   `DELETE /lists/{list_id}/items/{item_id}/`: Удаление товара из списка.
*   **Управление утилитами/состоянием пользователя для списка:**
    *   `GET /utils/{user_id}/lists/{list_id}/last_message/`: Получение ID последних сообщений, связанных со списком.
    *   `POST /utils/{user_id}/lists/{list_id}/last_message/`: Сохранение ID последнего сообщения.
    *   `DELETE /utils/{user_id}/lists/{list_id}/last_message/{message_id}/`: Удаление ID конкретного сообщения.
    *   `DELETE /utils/{user_id}/lists/{list_id}/last_message/clear/`: Очистка всех ID сообщений для списка.
    *   `GET /utils/{user_id}/lists/{list_id}/current_page/`: Получение текущей страницы отображения списка для пользователя.
    *   `POST /utils/{user_id}/lists/{list_id}/current_page/`: Установка текущей страницы.
    *   `DELETE /utils/{user_id}/lists/{list_id}/current_page/`: Удаление информации о текущей странице.
    *   `GET /utils/{user_id}/lists/{list_id}/skip_confirm/`: Проверка флага пропуска подтверждения.
    *   `POST /utils/{user_id}/lists/{list_id}/skip_confirm/`: Установка флага пропуска подтверждения.
    *   `DELETE /utils/{user_id}/lists/{list_id}/skip_confirm/`: Удаление флага пропуска подтверждения.
*   **Управление уведомлениями списка:**
    *   `POST /lists/{list_id}/notification/`: Установка текста последнего уведомления для списка.
    *   `POST /lists/{list_id}/clear_notification/`: Очистка текста последнего уведомления для списка.
*   **Проверка состояния сервиса:**
    *   `GET /health`: Эндпоинт для проверки работоспособности сервиса.

## 4. Примеры использования

Ниже приведены сценарии взаимодействия с сервисом, иллюстрирующие его основные функции. Предполагается, что `user_id` и `list_id` известны и корректны.

### Сценарий 1: Создание списка покупок и добавление товаров

1.  **Пользователь (например, с `user_id = 1001`) создает новый список покупок.**
    Клиент (Telegram-бот) отправляет запрос:
    `POST http://localhost:8001/lists/?user_id=1001`
    Тело запроса: отсутствует
    Пример ответа (200 OK):
    ```json
    {
      "list_id": "60d5f1bfa9c7a4a9d8f0b1c2"
    }
    ```
    Пусть полученный `list_id` будет "60d5f1bfa9c7a4a9d8f0b1c2".

2.  **Пользователь добавляет товар "Молоко" в созданный список.**
    Клиент отправляет запрос:
    `POST http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/items/`
    Тело запроса:
    ```json
    {
      "item_name": "Молоко"
    }
    ```
    Пример ответа (200 OK):
    ```json
    {
      "item_id": "60d5f1e7a9c7a4a9d8f0b1c3",
      "status": "item added"
    }
    ```

3.  **Пользователь добавляет несколько товаров ("Хлеб", "Яйца") одной операцией.**
    Клиент отправляет запрос:
    `POST http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/items/bulk/`
    Тело запроса:
    ```json
    {
      "items": [
        {"item_name": "Хлеб"},
        {"item_name": "Яйца"}
      ]
    }
    ```
    Пример ответа (200 OK):
    ```json
    {
      "added_items": ["Хлеб", "Яйца"]
    }
    ```

### Сценарий 2: Просмотр списка и отметка купленного товара

1.  **Пользователь запрашивает содержимое своего списка "60d5f1bfa9c7a4a9d8f0b1c2".**
    Клиент отправляет запрос:
    `GET http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/items/`
    Пример ответа (200 OK):
    ```json
    {
      "items": {
        "60d5f1e7a9c7a4a9d8f0b1c3": {"name": "Молоко", "bought": false},
        "some_item_id_хлеб": {"name": "Хлеб", "bought": false},
        "some_item_id_яйца": {"name": "Яйца", "bought": false}
      }
    }
    ```
    (Примечание: `some_item_id_хлеб` и `some_item_id_яйца` - это ID, присвоенные при массовом добавлении).

2.  **Пользователь отмечает "Молоко" (с `item_id = 60d5f1e7a9c7a4a9d8f0b1c3`) как купленное.**
    Клиент отправляет запрос:
    `PUT http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/items/60d5f1e7a9c7a4a9d8f0b1c3/toggle/`
    Тело запроса: отсутствует
    Пример ответа (200 OK):
    ```json
    {
      "status": "item toggled"
    }
    ```
    Теперь, если запросить список товаров снова, для "Молока" `bought` будет `true`.

### Сценарий 3: Предоставление общего доступа к списку

1.  **Пользователь (`user_id = 1001`, владелец списка `60d5f1bfa9c7a4a9d8f0b1c2`) хочет поделиться этим списком с пользователем `user_id = 1002`.**
    Клиент отправляет запрос:
    `POST http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/share/`
    Тело запроса:
    ```json
    {
      "user_id": 1002
    }
    ```
    Пример ответа (200 OK):
    ```json
    {
      "status": "list shared",
      "user_added": 1002
    }
    ```
    Теперь пользователь `1002` также имеет доступ к этому списку.

### Сценарий 4: Завершение списка покупок

1.  **Пользователь решает, что все покупки по списку `60d5f1bfa9c7a4a9d8f0b1c2` завершены.**
    Клиент отправляет запрос:
    `POST http://localhost:8001/lists/60d5f1bfa9c7a4a9d8f0b1c2/complete/`
    Тело запроса: отсутствует
    Пример ответа (200 OK):
    ```json
    {
      "status": "list completed",
      "users": [1001, 1002], // Пользователи, которые были в списке
      "items": [ // Товары, которые были в списке
        {"item_id": "60d5f1e7a9c7a4a9d8f0b1c3", "name": "Молоко", "bought": true},
        // ... другие товары
      ],
      "last_message_ids_for_users": { // ID сообщений для удаления/редактирования у клиентов
        "1001": [12345, 12346],
        "1002": [56789]
      }
    }
    ```
    После этого запроса список `60d5f1bfa9c7a4a9d8f0b1c2` будет удален из системы, и все связанные с ним данные пользователей (кроме истории действий) будут очищены.